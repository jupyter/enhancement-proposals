
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Replace PUB socket with XPUB socket &#8212; Jupyter Enhancement Proposals</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <link rel="canonical" href="https://jupyter.org/enhancement-proposals/jupyter-xpub/jupyter-xpub.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Jupyter Enhancement Proposals</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs..." aria-label="Search the docs..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   Jupyter Enhancement Proposals
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Information
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../jupyter-enhancement-proposal-guidelines/jupyter-enhancement-proposal-guidelines.html">
   Jupyter Enhancement Proposals (JEP) Guidelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/jupyter/enhancement-proposals/blob/master/jupyter-enhancement-proposal-guidelines/JEP-TEMPLATE.md">
   JEP Template
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Accepted JEPs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../72-language-server-protocol/language-server-protocol.html">
   Jupyter integration with the Language Server Protocol
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../62-cell-id/cell-id.html">
   Cell ID Addition to Notebook Format
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../47-jupyter-debugger-protocol/jupyter-debugger-protocol.html">
   Jupyter debugger protocol
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../44-xeus-incorporation/xeus-incorporation.html">
   Xeus Incorporation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../42-voila-incorporation/voila-incorporation.html">
   Voilà Incorporation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../29-jep-process/jep-process.html">
   Jupyter Enhancement Proposal
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../28-jupyter-server/jupyter-server.html">
   Standalone Jupyter server enhancement
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Implemented JEPs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../25-jupyter-enterprise-gateway-incorporation/jupyter-enterprise-gateway-incorporation.html">
   Jupyter Enterprise Gateway Incorporation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../22-jupyter-dashboards-deployment-attic/jupyter-dashboards-deployment-attic.html">
   Move the Jupyter Dashboards Deployment Projects from Incubator to Attic
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../18-jupyter-declarativewidgets-incorporation/jupyter-declarativewidgets-extension-incorporation.html">
   Jupyter DeclarativeWidgets Extension Incorporation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../17-jupyter-dashboards-extension-incorporation/jupyter-dashboards-extension-incorporation.html">
   Jupyter Dashboards Extension Incorporation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../12-jupyter-kernel-gateway-incorporation/jupyter-kernel-gateway-incorporation.html">
   Jupyter Kernel Gateway Incorporation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../08-notebook-diff/notebook-diff.html">
   Diffing and merging notebooks
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/jupyter-xpub/jupyter-xpub.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/jupyter/enhancement-proposals"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/jupyter/enhancement-proposals/issues/new?title=Issue%20on%20page%20%2Fjupyter-xpub/jupyter-xpub.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/jupyter/enhancement-proposals/edit/master/jupyter-xpub/jupyter-xpub.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem">
   Problem
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#current-solution">
   Current solution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#proposed-enhancement">
   Proposed Enhancement
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#impact-on-existing-implementations">
     Impact on existing implementations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#relevant-resources-github-repositories-issues-prs">
   Relevant Resources (GitHub repositories, Issues, PRs)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#github-repositories">
     GitHub repositories
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#github-issues">
     GitHub Issues
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#github-pull-requests">
     GitHub Pull Requests
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="replace-pub-socket-with-xpub-socket">
<h1>Replace PUB socket with XPUB socket<a class="headerlink" href="#replace-pub-socket-with-xpub-socket" title="Permalink to this headline">¶</a></h1>
<div class="section" id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h2>
<p>A Jupyter kernel uses a PUB socket as a broadcast channel where it publishes various messages (incoming requests, outputs, events). Any client that wants to be notified of what happens in the kernel can simply subscribe to this channel via a SUB socket. The issue with this simple PUB - SUB pattern is that <strong>there is no simple mechanism for clients to wait for their iopub subscription to be established.</strong></p>
<p>This is particularly problematic when a client needs to send a bunch of execution requests just after starting a kernel (a typical use case is the “Restart Kernel and execute all” command of Jupyter Lab, or opening a Notebook with Voilà). In that case, the client needs to ensure that its SUB socket is connected to the PUB socket of the kernel before sending any execution request, otherwise it may miss some outputs. The kernel, on its side, will not emit any event until it receives a request.</p>
</div>
<div class="section" id="current-solution">
<h2>Current solution<a class="headerlink" href="#current-solution" title="Permalink to this headline">¶</a></h2>
<p>The current solution consists of sending <code class="docutils literal notranslate"><span class="pre">kernel_info</span></code> requests until a <code class="docutils literal notranslate"><span class="pre">kernel_info</span></code> reply is received on the SHELL and an idle status message is received on the SUB socket. If the client receives a <code class="docutils literal notranslate"><span class="pre">kernel_info</span></code> reply but not the idle status message before a timeout, this means that the SUB socket has not connected yet. The client discards the reply and send a new <code class="docutils literal notranslate"><span class="pre">kernel_info</span></code> request.</p>
<p>This solution makes the implementation of a Jupyter client more complicated than required. Indeed, ZeroMQ provides a publisher socket that is able to detect new subscriptions.</p>
</div>
<div class="section" id="proposed-enhancement">
<h2>Proposed Enhancement<a class="headerlink" href="#proposed-enhancement" title="Permalink to this headline">¶</a></h2>
<p>We propose to replace the PUB socket of the kernel with an XPUB socket. XPUB sockets receive the following events:</p>
<ul class="simple">
<li><p>subscribe (single frame messages with <code class="docutils literal notranslate"><span class="pre">\1{subscription-topic}</span></code>)</p></li>
<li><p>unsubscribe (single frame messages with <code class="docutils literal notranslate"><span class="pre">\0{subscription-topic}</span></code>)</p></li>
</ul>
<p>When the IOPub XPUB socket receives an event indicating a new subscription, it shall send an <code class="docutils literal notranslate"><span class="pre">iopub_welcome</span></code> message with no parent header and the received
subscription in the <code class="docutils literal notranslate"><span class="pre">subscription</span></code> field, <em>with the given subscription topic</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">identity_prefix</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;subscription-topic&quot;</span><span class="p">]</span>
<span class="n">parent_header</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">header</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;msg_type&quot;</span><span class="p">:</span> <span class="s2">&quot;iopub_welcome&quot;</span>
<span class="p">}</span>
<span class="n">content</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;subscription&quot;</span><span class="p">:</span> <span class="s2">&quot;subscription-topic&quot;</span>
<span class="p">}</span>
<span class="n">metadata</span><span class="p">:</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Notes:</p>
<ul class="simple">
<li><p>The identity prefix may contain extra information about the message, such as the kernel id, according to the convention used in the IPython kernel:
<code class="docutils literal notranslate"><span class="pre">kernel.{u-u-i-d}.subscription-topic</span></code>.</p></li>
<li><p>Subscriptions can be empty (this is almost always the case). An empty subscription means subscribing to all IOPub messages.</p></li>
<li><p>Subscriptions shall be UTF-8 encoded. Non-utf8 subscriptions shall be ignored, and not produce a welcome message.</p></li>
<li><p>Every subscribed client will receive every other client’s welcome message, assuming they match existing subscriptions (e.g. empty strings)</p></li>
<li><p>Welcome messages do not and cannot identify the client whose subscription is being received. Receipt of an iopub_welcome message with your subscription does not mean it is in response to your own subscription. However, receiving a message does mean that a matching subscription has been registered for your client, otherwise no message will be received. So if only one subscription is registered, as is normally the case, receiving any welcome message is sufficient to indicate that your client’s subscription is fully established. The gist is that receiving a welcome message is a sufficient condition to establish the subscription-propagation event, and additional welcome messages should be expected and ignored.</p></li>
<li><p>Unsubscribe events are ignored.</p></li>
</ul>
<div class="section" id="impact-on-existing-implementations">
<h3>Impact on existing implementations<a class="headerlink" href="#impact-on-existing-implementations" title="Permalink to this headline">¶</a></h3>
<p>Although this enhancement requires changing all the existing kernels, the impact should be limited. Indeed, most of the kernels are based on the kernel wrapper approach, or on xeus.</p>
<p>Regarding clients, this change is backward-incompatible only when they start assuming a welcome message will come. Clients not aware of
the new message will just get an unrecognized iopub message they can safely ignore.</p>
<p>Most of the clients are based on the Jupyter Server. Therefore, the changes should be limited to this repository and to the notebook. The new
recommended starting procedure is:</p>
<ol class="arabic simple">
<li><p>always probe with a single <code class="docutils literal notranslate"><span class="pre">kernel_info_request</span></code> (required for protocol adaptation)</p></li>
<li><p>check protocol version in reply
i. if welcome message is supported, wait for it on iopub
ii. if not:
a. use current request &amp; wait loop (recommended, especially for current clients that already have this implemented)
b. accept and warn about possible loss of early iopub messages for ‘old’ kernels ((increasingly common over time as protocol updates can be more safely assumed, especially for new clients</p></li>
</ol>
</div>
</div>
<div class="section" id="relevant-resources-github-repositories-issues-prs">
<h2>Relevant Resources (GitHub repositories, Issues, PRs)<a class="headerlink" href="#relevant-resources-github-repositories-issues-prs" title="Permalink to this headline">¶</a></h2>
<div class="section" id="github-repositories">
<h3>GitHub repositories<a class="headerlink" href="#github-repositories" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Jupyter Client: <a class="reference external" href="https://github.com/jupyter/jupyter_client">https://github.com/jupyter/jupyter_client</a>
The Jupyter protocol client APIs</p></li>
<li><p>Jupyter Server: <a class="reference external" href="https://github.com/jupyter-server/jupyter_server">https://github.com/jupyter-server/jupyter_server</a>
The backend to Jupyter web applications</p></li>
<li><p>Jupyter Notebook: <a class="reference external" href="https://github.com/jupyter/notebook">https://github.com/jupyter/notebook</a>
The Jupyter interactive notebook</p></li>
<li><p>IPyKernel: <a class="reference external" href="https://github.com/ipython/ipykernel">https://github.com/ipython/ipykernel</a>
IPython kernel for Jupyter</p></li>
<li><p>Xeus: <a class="reference external" href="https://github.com/jupyter-xeus/xeus">https://github.com/jupyter-xeus/xeus</a>
The C++ implementation of the Jupyter kernel protocol</p></li>
</ul>
</div>
<div class="section" id="github-issues">
<h3>GitHub Issues<a class="headerlink" href="#github-issues" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Main issue in jupyter_client: SUB sockets take time to subscribe to the IOPub channel and miss important messages (<a class="reference external" href="https://github.com/jupyter/jupyter_client/issues/593">https://github.com/jupyter/jupyter_client/issues/593</a>)</p></li>
<li><p>Related issue in Xeus for implementation detail: Implement Last Value Cache pattern for iopub (<a class="reference external" href="https://github.com/jupyter-xeus/xeus/issues/266">https://github.com/jupyter-xeus/xeus/issues/266</a>)</p></li>
</ul>
</div>
<div class="section" id="github-pull-requests">
<h3>GitHub Pull Requests<a class="headerlink" href="#github-pull-requests" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>in jupyter_client: retry kernel_info_requests in wait_for_ready (<a class="reference external" href="https://github.com/jupyter/jupyter_client/pull/592">https://github.com/jupyter/jupyter_client/pull/592</a>)</p></li>
<li><p>in jupyter_server: Nudge kernel with info request until we receive IOPub messages (<a class="reference external" href="https://github.com/jupyter-server/jupyter_server/pull/361">https://github.com/jupyter-server/jupyter_server/pull/361</a>)</p></li>
<li><p>in notebook: ensure iopub subscriptions propagate prior to accepting websocket connections (<a class="reference external" href="https://github.com/jupyter/notebook/pull/5908">https://github.com/jupyter/notebook/pull/5908</a>)</p></li>
</ul>
</div>
</div>
</div>


              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Project Jupyter<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>